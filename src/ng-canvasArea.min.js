!function(t){"use strict";t.module("ngCanvasArea",[]).directive("ngCanvasArea",[function(t){return{restrict:"A",scope:{imagepath:"=",points:"=",maxPoints:"="},transclude:!0,link:function(t,n,e){t.$watch("imagepath",function(){t.init()}),t.$watch("maxPoints",function(n){t.maxPoints=n}),t.$watch("points",function(n){0==n.length&&t.init()})},controller:"ngCanvasAreaController"}}]).controller("ngCanvasAreaController",["$scope","$element",function(t,n){function e(t,n){this.x=t,this.y=n}t.init=function(){$(n).html(""),t.reset=$('<button class="btn btn-warning btn-lg"><span class="glyphicon glyphicon-trash"></span> Clear</button>'),t.canvas=$("<canvas class='img-responsive'>"),t.ctx=t.canvas[0].getContext("2d"),t.image=new Image,$(t.image).load(function(){t.resize()}),t.image.src=t.imagepath,t.canvas.css({background:"url("+t.image.src+")"}),$(document).ready(function(){$(n).append("<br>",t.canvas,"<br>",t.reset),t.reset.click(t.resetFunc),$(t.canvas).on("mousedown",t.mousedown),$(t.canvas).on("contextmenu",t.rightclick),$(t.canvas).on("mouseup",t.stopdrag)})},e.prototype.equals=function(t){return this.x==t.x&&this.y==t.y},e.prototype.distance=function(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))},t.resize=function(){t.canvas.attr("height",t.image.height).attr("width",t.image.width),t.draw()},t.resetFunc=function(){t.points=[],t.$apply(),t.draw()},t.draw=function(){if(t.ctx.canvas.width=t.ctx.canvas.width,t.points.length<1)return!1;t.ctx.globalCompositeOperation="destination-over",t.ctx.fillStyle="rgb(255,255,255)",t.ctx.strokeStyle="rgb(20,255,20)",t.ctx.lineWidth=1,t.ctx.beginPath(),t.ctx.moveTo(t.points[0].x,t.points[0].y);for(var n=0;n<t.points.length;n+=1)t.ctx.fillRect(t.points[n].x-2,t.points[n].y-2,4,4),t.ctx.strokeRect(t.points[n].x-2,t.points[n].y-2,4,4),t.points.length>1&&t.ctx.lineTo(t.points[n].x,t.points[n].y);t.ctx.closePath(),t.ctx.fillStyle="rgba(0,255,0,0.1)",t.ctx.fill(),t.ctx.stroke()},t.move=function(n){n.offsetX||(n.offsetX=n.pageX-$(n.target).offset().left,n.offsetY=n.pageY-$(n.target).offset().top),t.points[t.activePoint]=new e(Math.round(n.offsetX),Math.round(n.offsetY)),t.draw()},t.rightclick=function(n){n.preventDefault(),n.offsetX||(n.offsetX=n.pageX-$(n.target).offset().left,n.offsetY=n.pageY-$(n.target).offset().top);for(var e=n.offsetX,o=n.offsetY,i=0;i<t.points.length;i+=1)if(dis=Math.sqrt(Math.pow(e-t.points[i],2)+Math.pow(o-t.points[i+1],2)),dis<6)return t.points.splice(i,1),t.draw(),!1;return!1},t.stopdrag=function(){$(this).off("mousemove"),t.activePoint=null,t.points=t.convexHull(t.points),t.$apply(),t.draw()},t.mousedown=function(n){var o,i,s,a=t.points.length;if(3===n.which)return!1;n.preventDefault(),n.offsetX||(n.offsetX=n.pageX-$(n.target).offset().left,n.offsetY=n.pageY-$(n.target).offset().top),o=n.offsetX,i=n.offsetY;for(var r=0;r<t.points.length;r+=1)if(s=Math.sqrt(Math.pow(o-t.points[r].x,2)+Math.pow(i-t.points[r].y,2)),6>s)return t.activePoint=r,$(this).on("mousemove",t.move),!1;return t.points.length<t.maxPoints&&(t.points.splice(a,0,new e(Math.round(o),Math.round(i))),t.activePoint=a,t.$apply(),$(this).on("mousemove",t.move)),t.points.length==t.maxPoints&&(t.points=t.convexHull(t.points)),t.draw(),!1},t.convexHull=function(t){function n(t,n,e){var o=(n.x-t.x)*(e.y-t.y)-(e.x-t.x)*(n.y-t.y);return o>0?!0:0>o?!1:t.distance(e)>t.distance(n)}for(var e=t.length,o=[],i=0,s=1;s!=e;s++)t[s].y<t[i].y&&(i=s);var a=t[i];do{o.push(a);for(var r=t[0],s=1;s!=e;s++)(a.equals(r)||n(a,r,t[s]))&&(r=t[s]);a=r}while(!r.equals(o[0]));return o}}])}(angular);
